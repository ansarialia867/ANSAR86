<!DOCTYPE html>
<html lang="id"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="UTF-8"><title>aplikasi-saya</title></head><body class="bg-slate-100 dark:bg-slate-900">


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjualan Embun Wangi</title>
    <meta name="theme-color" content="#8B5CF6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
    <!-- jsPDF and AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS (XLSX) library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view { display: none; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .modal-open { overflow: hidden; }
        #app-container.hidden { display: none; }
        #branch-selector-container.hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #8B5CF6; /* Purple */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #offline-indicator {
            transition: all 0.5s ease-in-out;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>



    <!-- Branch Selector -->
    <div id="branch-selector-container" class="relative flex justify-center items-center min-h-screen p-4">
         <!-- Support Widget -->
        <div class="absolute top-5 right-5">
            <button id="support-icon" class="bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-110">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.447-4.435-9.884-9.888-9.884-5.448 0-9.886 4.434-9.889 9.884-.001 2.225.651 4.315 1.847 6.062l-1.011 3.712 3.717-1.005zm5.744-7.405c-.586-.295-3.446-1.707-3.98-1.896-.533-.188-.914-.295-1.294.294-.38.59-.149 1.355.101 1.804.248.45.496.9.693 1.188.198.29.33.494.03.936-.298.44-.132.826-.297 1.105-.166.278-.33.295-.61.111-.28-.184-1.18-1.11-1.517-1.896-.337-.785-.533-1.448-.533-2.146 0-.698.249-1.145.496-1.592.247-.448.584-.827.914-1.106.33-.278.694-.375.914-.375.221 0 .442.018.639.018.28.001.33.018.512.529.182.512.182 1.169.182 1.265s-.018.188-.08.282c-.061.094-.132.111-.28.184-.149.072-.33.166-.496.237-.165.072-.28.094-.496.295-.216.2-.442.448-.533.59-.092.142-.183.331-.072.512.11.182.248.413.33.557.081.142.166.166.248.184.081.018.149.018.221.018.141 0 .33-.018.496-.129.165-.111.33-.24.441-.375.111-.133.166-.237.28-.375.112-.137.221-.205.33-.093.11.111.533.785.625.936.092.149.149.166.221.166.072 0 .149-.018.221-.018.165-.018.33-.093.496-.184.165-.094.28-.129.412-.205.132-.072.221-.111.33-.184.11-.072.182-.149.28-.282.098-.133.149-.24.149-.448s-.018-.557-.08-.651c-.06-.094-.132-.111-.182-.111-.05-.001-.111.001-.182.001z"></path></svg>
            </button>
            <div id="support-popup" class="hidden absolute top-16 right-0 bg-white dark:bg-slate-700 p-4 rounded-lg shadow-xl w-64 transition-all transform origin-top-right">
                <p class="text-sm text-slate-700 dark:text-slate-200">Ada kendala? Hubungi <a href="https://chat.whatsapp.com/IFTIBXUdJDPL1PmSfzdg1U" target="_blank" rel="noopener noreferrer" class="font-bold text-purple-600 hover:underline">ANSAR-EWAI</a></p>
            </div>
        </div>
        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h1 id="welcome-title" class="text-3xl font-bold text-purple-800 dark:text-purple-400 mb-2">Selamat Datang</h1>
            <p class="text-slate-600 dark:text-slate-300 mb-8">Silakan pilih cabang yang akan dikelola.</p>
            <div class="space-y-4">
                 <input id="branch-selection-input" list="branch-datalist-selection" placeholder="Cari atau pilih cabang..." class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                 <datalist id="branch-datalist-selection"></datalist>
                <button id="select-branch-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-md">
                    Masuk ke Cabang
                </button>
            </div>
             <button id="manage-branches-btn" class="mt-6 text-sm text-purple-600 dark:text-purple-400 hover:underline">
                Kelola Daftar Cabang
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="flex flex-col md:flex-row min-h-screen">
            <!-- Sidebar Navigation -->
            <nav class="bg-white dark:bg-slate-800 md:w-64 p-4 flex md:flex-col justify-between md:justify-start shadow-lg">
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                           <h1 id="sidebar-title" class="text-2xl font-bold text-purple-800 dark:text-purple-400 text-left">
                                Embun Wangi
                            </h1>
                            <p class="text-sm text-slate-500 dark:text-slate-400 text-left">Aplikasi Kasir</p>
                        </div>
                        <div id="offline-indicator" class="w-4 h-4 rounded-full bg-red-500 mt-1" title="Anda sedang offline"></div>
                    </div>
                     <div class="text-center md:text-left mb-4 bg-purple-100 dark:bg-slate-700 p-2 rounded-md">
                        <p class="font-bold text-purple-600 dark:text-purple-300" id="current-branch-display">Memuat...</p>
                    </div>
                    <ul class="space-y-2" id="nav-menu">
                        <li><button data-view="input" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left bg-purple-600 text-white shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span class="hidden md:inline">Input Penjualan</span></button></li>
                        <li><button data-view="history" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span class="hidden md:inline">History Harian</span></button></li>
                        <li><button data-view="grouped" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path><path d="m3.3 7 8.7 5 8.7-5"></path><path d="M12 22V12"></path></svg><span class="hidden md:inline">Rekap Item</span></button></li>
                        <li><button data-view="expenses" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span class="hidden md:inline">Pengeluaran</span></button></li>
                        <li><button data-view="recap" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"></line><line x1="18" x2="18" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="16"></line></svg><span class="hidden md:inline">Rekap Harian</span></button></li>
                        <li><button data-view="global-report" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download-cloud"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m8 17 4 4 4-4"></path></svg><span class="hidden md:inline">Unduh Laporan</span></button></li>
                        <li><button data-view="master-report" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors text-left text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg><span class="hidden md:inline">Laporan Master</span></button></li>
                    </ul>
                </div>
                <div class="mt-auto space-y-2">
                    <button id="change-branch-btn" class="w-full flex items-center justify-center md:justify-start gap-3 p-3 text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-replace"><path d="M14 4c0-1.1.9-2 2-2s2 .9 2 2"></path><path d="M20 10c0-1.1.9-2 2-2s2 .9 2 2"></path><path d="m22 16-4-4 4-4"></path><path d="M8 14A6 6 0 0 0 2 8c0-1.1.9-2 2-2s2 .9 2 2"></path><path d="M4 20c0-1.1.9-2 2-2s2 .9 2 2"></path><path d="m2 16 4 4-4 4"></path></svg><span class="hidden md:inline">Ganti Cabang</span></button>
                    <button id="theme-toggle" class="w-full flex items-center justify-center md:justify-start gap-3 p-3 text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white rounded-lg transition-colors"><svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="hidden md:inline">Ganti Tema</span></button>
                    <button id="open-settings-btn" class="w-full flex items-center justify-center md:justify-start gap-3 p-3 text-slate-600 dark:text-slate-300 hover:bg-purple-50 dark:hover:bg-slate-700 hover:text-purple-800 dark:hover:text-white rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg><span class="hidden md:inline">Pengaturan</span></button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8">
                <div id="view-input" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Input Penjualan Baru</h2><form id="sales-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Toko</label><input id="input-shop-name" type="text" disabled="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-slate-100 dark:bg-slate-700 dark:text-slate-300"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Penjual</label><input id="input-seller-name" type="text" required="" placeholder="Masukkan nama penjual" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div class="md:col-span-2 border-t border-slate-200 dark:border-slate-700 mt-2"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Parfum</label><input id="perfumeName" list="perfume-list" type="text" placeholder="Cari atau pilih parfum..." required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><datalist id="perfume-list"></datalist></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Mili Parfum</label><input id="perfumeMili" type="text" placeholder="Contoh: 30" required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Harga per ml (Rp)</label><input id="pricePerMl" type="text" placeholder="Contoh: 2000" required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Harga Botol (Rp)</label><input id="bottlePrice" type="text" placeholder="Contoh: 5000" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Ukuran Botol Parfum</label><input id="bottleSize" list="bottle-size-list" type="text" placeholder="Cari atau pilih ukuran botol..." required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"><datalist id="bottle-size-list"></datalist></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Pcs Botol Parfum</label><input id="bottlePcs" type="text" value="1" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Diskon (Rp)</label><input id="discount" type="text" value="0" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div></div><div class="flex items-center pt-2 md:col-span-2"><input id="is-refill-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-slate-500 text-purple-600 focus:ring-purple-500"><label for="is-refill-checkbox" class="ml-2 block text-sm font-medium text-slate-700 dark:text-slate-300">Ini adalah Isi Ulang (Tanpa Botol Baru)</label></div><div class="mt-6 pt-4 border-t border-purple-200 dark:border-slate-600 space-y-4"><div class="flex justify-between items-center bg-purple-50 dark:bg-slate-700 p-4 rounded-lg"><span class="text-lg font-bold text-purple-800 dark:text-purple-300">Total Jual</span><span id="total-jual-display" class="text-lg font-bold text-purple-800 dark:text-purple-300">Rp 0</span></div><div class="flex justify-center"><button type="submit" class="w-full md:w-1/2 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-md flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Simpan Penjualan</button></div></div></form></div></div>
                <div id="view-history" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2" id="history-title">History Penjualan Hari Ini</h2><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500 dark:text-slate-400"><thead class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-purple-50 dark:bg-slate-700"><tr><th class="px-6 py-3">Parfum</th><th class="px-6 py-3">Penjual</th><th class="px-6 py-3">Total Harga</th><th class="px-6 py-3">Diskon</th><th class="px-6 py-3">Detail</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="history-table-body"></tbody></table></div></div></div>
                <div id="view-grouped" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Rekap Item Terjual Hari Ini</h2><div id="grouped-report-container" class="space-y-4"></div></div></div>
                <div id="view-expenses" class="view"><div class="space-y-6"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Input Pengeluaran Harian</h2><form id="expenses-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Jenis Pengeluaran</label><select id="expense-type" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"><option>Biaya Operasional</option><option>Gaji Karyawan</option><option>Listrik</option><option>Transportasi</option><option>Lain-lain</option></select></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Keterangan</label><input id="expense-description" type="text" placeholder="Contoh: Beli galon air" required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Jumlah (Rp)</label><input id="expense-amount" type="text" placeholder="Contoh: 50000" required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div class="md:col-span-3 flex justify-end"><button type="submit" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-md flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Tambah Pengeluaran</button></div></div></form></div><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Daftar Pengeluaran Hari Ini</h2><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500 dark:text-slate-400"><thead class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-purple-50 dark:bg-slate-700"><tr><th class="px-6 py-3">Jenis</th><th class="px-6 py-3">Keterangan</th><th class="px-6 py-3">Jumlah</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="expenses-table-body"></tbody></table></div></div></div></div>
                <div id="view-recap" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Rekap Keuangan Harian</h2><div class="space-y-3 text-slate-700 dark:text-slate-300"><div class="flex justify-between items-center py-2"><span class="font-medium">Total Omset Bruto Harian</span><span id="recap-gross-sales" class="dark:text-white">Rp 0</span></div><div class="flex justify-between items-center py-2"><span class="font-medium">Total Diskon Harian</span><span id="recap-total-discount" class="text-red-600 dark:text-red-500">- Rp 0</span></div><div class="flex justify-between items-center py-2"><span class="font-bold">Total Penjualan Bersih Harian</span><span id="recap-net-sales" class="font-bold dark:text-white">Rp 0</span></div><div class="flex justify-between items-center py-2"><span class="font-medium">Bonus Omset</span><input id="recap-bonus" type="text" value="0" class="w-32 p-1 border border-slate-300 dark:border-slate-600 rounded-md text-right bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></div><div class="flex justify-between items-center py-2"><span class="font-medium">Total Pengeluaran Harian</span><span id="recap-total-expenses" class="text-red-600 dark:text-red-500">- Rp 0</span></div><div class="border-t border-purple-200 dark:border-slate-600 pt-3 mt-3"><div class="flex justify-between items-center py-2 text-lg"><span class="font-bold">TOTAL BERSIH HARIAN</span><span id="recap-net-profit" class="font-extrabold text-purple-700 dark:text-purple-400">Rp 0</span></div></div></div><div class="mt-8 flex flex-col md:flex-row justify-end gap-3"><button id="create-pdf-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Buat PDF Laporan</button><button id="send-wa-report-btn" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>Kirim Laporan via WhatsApp</button></div></div></div>
                <div id="view-global-report" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Unduh Laporan Cabang</h2><div class="flex flex-col sm:flex-row items-end gap-4"><div class="flex-grow w-full sm:w-auto"><label for="global-report-branch" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Pilih Cabang</label><input id="global-report-branch" list="branch-datalist-selection" placeholder="Cari atau pilih cabang..." class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></div><div class="flex-grow w-full sm:w-auto"><label for="global-report-date" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Pilih Tanggal</label><input id="global-report-date" type="date" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></div><button id="download-global-report-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Unduh PDF</button></div><div id="global-report-loader" class="hidden mt-6 flex flex-col items-center justify-center"><div class="loader"></div><p class="mt-4 text-slate-600 dark:text-slate-300">Mengambil data dan membuat laporan...</p></div></div></div>
                <div id="view-master-report" class="view"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"><h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Laporan Master Global</h2><div id="passcode-section"><p class="text-slate-600 dark:text-slate-300 mb-4">Fitur ini dilindungi. Masukkan kode sandi untuk melanjutkan.</p><div class="flex items-center gap-4"><input id="passcode-input" type="password" placeholder="Kode Sandi" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"><button id="passcode-submit-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Buka</button></div></div><div id="master-report-controls" class="hidden"><div class="flex flex-col sm:flex-row items-end gap-4"><div class="flex-grow"><label for="master-report-month" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Pilih Bulan &amp; Tahun</label><input id="master-report-month" type="month" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></div></div><div class="flex flex-wrap gap-2 mt-4"><button id="download-monthly-finance-pdf-btn" class="w-full sm:w-auto bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M16 13H8"></path><path d="M16 17H8"></path><path d="M10 9H8"></path></svg>PDF Keuangan Bulanan</button><button id="download-master-excel-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-4"></path><polyline points="16 12 12 8 8 12"></polyline><line x1="12" y1="16" x2="12" y2="8"></line></svg>Unduh Excel Bulanan</button><button id="print-master-report-btn" class="w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>Cetak Laporan Lengkap</button></div></div><div id="master-report-loader" class="hidden mt-6 flex flex-col items-center justify-center"><div class="loader"></div><p class="mt-4 text-slate-600 dark:text-slate-300">Mengambil data dan membuat laporan...</p></div></div></div></main></div>
            
        </div>
    

    <!-- Branch Management Modal -->
    <div id="branch-management-modal" class="fixed inset-0 modal-backdrop flex justify-center items-center z-[100] p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-lg relative transform transition-all scale-95 opacity-0" id="branch-modal-content">
             <button id="close-branch-modal-btn" class="absolute top-4 right-4 text-slate-500 dark:text-slate-300 hover:text-slate-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <div class="space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border border-slate-200 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Tambah Cabang Baru</h2>
                    <form id="branch-form" class="flex items-end gap-4"><div class="flex-grow"><label for="branch-name-input" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Cabang</label><input id="branch-name-input" type="text" placeholder="Contoh: Cabang Jakarta" required="" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><button type="submit" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-md flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Tambah</button></form>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border border-slate-200 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-4 border-b border-purple-200 dark:border-slate-600 pb-2">Daftar Cabang</h2>
                    <div id="branch-list-container" class="space-y-3 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-md relative"><button id="close-settings-btn" class="absolute top-4 right-4 text-slate-500 dark:text-slate-300 hover:text-slate-800 dark:hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button><h2 class="text-2xl font-bold text-purple-800 dark:text-purple-400 mb-6">Pengaturan Aplikasi</h2><form id="settings-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Toko Global</label><input id="setting-shop-name" type="text" placeholder="Nama brand Anda" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nomor WhatsApp Pusat</label><input id="setting-whatsapp-number" type="text" placeholder="6281234567890 (awali dengan 62)" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"></div><div class="mt-8 flex justify-end"><button type="submit" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Simpan Pengaturan</button></div></form></div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="fixed inset-0 modal-backdrop flex justify-center items-center z-[100] p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" id="custom-modal-content"><p id="custom-modal-message" class="text-slate-800 dark:text-slate-200 mb-6 text-lg"></p><div id="custom-modal-buttons" class="flex justify-center gap-4"></div></div>
    </div>

    <!-- Printable Area -->
    <div id="print-area" class="hidden"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, writeBatch, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth, userId, activeBranch;
        let unsubscribeSales, unsubscribeExpenses, unsubscribeSettings, unsubscribeBranches;
        let initialBranchCheckDone = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            showCustomAlert("Gagal terhubung ke server. Silakan refresh halaman.", "error");
        }

        let sales = [];
        let expenses = [];
        let branches = [];
        let settings = { shopName: 'EMBUN WANGI PARFUME', whatsAppNumber: '' };

        const getTodayDateString = () => new Date().toISOString().slice(0, 10);
        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(isNaN(value) ? 0 : value);
        const onlyNumbers = (value) => value.replace(/[^0-9]/g, '');

        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item');
        const salesForm = document.getElementById('sales-form');
        const expensesForm = document.getElementById('expenses-form');
        const settingsForm = document.getElementById('settings-form');
        const branchForm = document.getElementById('branch-form');
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const sendWaReportBtn = document.getElementById('send-wa-report-btn');
        const createPdfBtn = document.getElementById('create-pdf-btn');
        const isRefillCheckbox = document.getElementById('is-refill-checkbox');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const customModal = document.getElementById('custom-modal');
        const customModalContent = document.getElementById('custom-modal-content');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalButtons = document.getElementById('custom-modal-buttons');
        const branchSelectorContainer = document.getElementById('branch-selector-container');
        const appContainer = document.getElementById('app-container');
        const selectBranchBtn = document.getElementById('select-branch-btn');
        const branchSelectionInput = document.getElementById('branch-selection-input');
        const changeBranchBtn = document.getElementById('change-branch-btn');
        const branchManagementModal = document.getElementById('branch-management-modal');
        const branchModalContent = document.getElementById('branch-modal-content');
        const manageBranchesBtn = document.getElementById('manage-branches-btn');
        const closeBranchModalBtn = document.getElementById('close-branch-modal-btn');
        const globalReportDateInput = document.getElementById('global-report-date');
        const downloadGlobalReportBtn = document.getElementById('download-global-report-btn');
        const globalReportLoader = document.getElementById('global-report-loader');
        const passcodeSection = document.getElementById('passcode-section');
        const masterReportControls = document.getElementById('master-report-controls');
        const passcodeSubmitBtn = document.getElementById('passcode-submit-btn');
        const masterReportMonthInput = document.getElementById('master-report-month');
        const downloadMasterExcelBtn = document.getElementById('download-master-excel-btn');
        const masterReportLoader = document.getElementById('master-report-loader');
        const sidebarTitle = document.getElementById('sidebar-title');
        const welcomeTitle = document.getElementById('welcome-title');
        const inputShopName = document.getElementById('input-shop-name');
        const downloadMonthlyFinanceBtn = document.getElementById('download-monthly-finance-pdf-btn');
        const supportIcon = document.getElementById('support-icon');
        const supportPopup = document.getElementById('support-popup');
        const offlineIndicator = document.getElementById('offline-indicator');
        const printMasterReportBtn = document.getElementById('print-master-report-btn');

        const showCustomModal = (contentEl = customModalContent) => {
            const modal = contentEl.closest('.fixed');
            document.body.classList.add('modal-open');
            modal.classList.remove('hidden');
            setTimeout(() => contentEl.classList.remove('scale-95', 'opacity-0'), 10);
        };

        const hideCustomModal = (contentEl = customModalContent) => {
            const modal = contentEl.closest('.fixed');
            contentEl.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 200);
        };

        const showCustomAlert = (message) => {
            customModalMessage.textContent = message;
            customModalButtons.innerHTML = `<button id="modal-ok-btn" class="bg-purple-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-purple-700 transition">OK</button>`;
            showCustomModal();
            document.getElementById('modal-ok-btn').addEventListener('click', () => hideCustomModal(), { once: true });
        };

        const showCustomConfirm = (message, onConfirm) => {
            customModalMessage.textContent = message;
            customModalButtons.innerHTML = `<button id="modal-cancel-btn" class="bg-slate-300 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-2 px-6 rounded-lg">Batal</button><button id="modal-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Hapus</button>`;
            showCustomModal();
            document.getElementById('modal-confirm-btn').onclick = () => { hideCustomModal(); onConfirm(); };
            document.getElementById('modal-cancel-btn').onclick = () => hideCustomModal();
        };

        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeIconLight.classList.toggle('hidden', theme === 'dark');
            themeIconDark.classList.toggle('hidden', theme !== 'dark');
            localStorage.setItem('theme', theme);
        };

        const renderAll = () => {
            renderSalesHistory();
            renderGroupedReport();
            renderExpenses();
            renderRecap();
        };
        
        const renderBranchManagementView = () => {
            const container = document.getElementById('branch-list-container');
            container.innerHTML = branches.length === 0 ? '<p class="text-slate-500 dark:text-slate-400 text-center py-4">Belum ada cabang.</p>' : '';
            branches.forEach(branch => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-slate-50 dark:bg-slate-700 p-3 rounded-lg';
                div.innerHTML = `<span class="font-medium text-slate-800 dark:text-slate-200">${branch.name}</span><button data-id="${branch.id}" class="delete-branch-btn text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                container.appendChild(div);
            });
            container.querySelectorAll('.delete-branch-btn').forEach(btn => btn.onclick = (e) => showCustomConfirm('Menghapus cabang akan menghapus semua datanya. Yakin?', () => deleteBranch(e.currentTarget.dataset.id)));
        };

        const renderBranchSelectors = () => {
            const datalist = document.getElementById('branch-datalist-selection');
            datalist.innerHTML = '';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                datalist.appendChild(option);
            });
        };

        const renderSalesHistory = () => {
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = '';
            if (sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 dark:text-slate-400 py-8">Belum ada penjualan hari ini.</td></tr>';
                return;
            }
            sales.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-purple-50 dark:hover:bg-slate-700';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${sale.perfumeName} (${sale.perfumeMili}ml)</td><td class="px-6 py-4">${sale.sellerName}</td><td class="px-6 py-4">${formatCurrency(sale.price)}</td><td class="px-6 py-4">${formatCurrency(sale.discount)}</td><td class="px-6 py-4">${sale.bottlePcs} pcs, Botol ${sale.bottleSize} ${sale.isRefill ? '(Isi Ulang)' : ''}</td><td class="px-6 py-4"><button data-id="${sale.id}" class="delete-sale-btn text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></td>`;
                tableBody.appendChild(row);
            });
            tableBody.querySelectorAll('.delete-sale-btn').forEach(btn => btn.onclick = (e) => showCustomConfirm('Yakin ingin menghapus penjualan ini?', () => deleteSale(e.currentTarget.dataset.id)));
        };

        const getGroupedSales = () => {
            return Object.values(sales.reduce((acc, sale) => {
                const key = sale.perfumeName.trim().toLowerCase();
                if (!acc[key]) acc[key] = { perfumeName: sale.perfumeName, totalMili: 0, bottles: {}, sellers: {}, totalRevenue: 0, totalDiscount: 0 };
                const saleMili = sale.perfumeMili * sale.bottlePcs;
                acc[key].totalMili += saleMili;
                acc[key].totalRevenue += sale.price;
                acc[key].totalDiscount += sale.discount;
                if (!sale.isRefill) {
                    acc[key].bottles[sale.bottleSize] = (acc[key].bottles[sale.bottleSize] || 0) + sale.bottlePcs;
                }
                const sellerKey = sale.sellerName.trim();
                if (!acc[key].sellers[sellerKey]) acc[key].sellers[sellerKey] = { totalMili: 0, transactions: [] };
                acc[key].sellers[sellerKey].totalMili += saleMili;
                acc[key].sellers[sellerKey].transactions.push(`${sale.perfumeMili}ml (${sale.bottlePcs} pcs)`);
                return acc;
            }, {}));
        };

        const renderGroupedReport = () => {
            const container = document.getElementById('grouped-report-container');
            container.innerHTML = '';
            const groupedArray = getGroupedSales();
            if (groupedArray.length === 0) {
                container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Belum ada penjualan untuk direkap.</p>';
                return;
            }
            groupedArray.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-purple-50 dark:bg-slate-700 p-4 rounded-lg border border-purple-200 dark:border-slate-600';
                const bottleList = Object.entries(item.bottles).map(([size, count]) => `<li class="ml-4 text-sm text-slate-600 dark:text-slate-300">- Botol ${size}: ${count} pcs</li>`).join('');
                const sellerList = Object.entries(item.sellers).map(([name, data]) => `<li class="ml-4 text-sm text-slate-600 dark:text-slate-300">- ${name}: ${data.totalMili} ml (${data.transactions.join(', ')})</li>`).join('');
                itemDiv.innerHTML = `<h3 class="font-bold text-purple-800 dark:text-purple-400">${item.perfumeName}</h3><div class="mt-2 text-sm space-y-2 text-slate-700 dark:text-slate-300"><p><span class="font-medium">Total Terjual (Parfum):</span> ${item.totalMili} ml</p><div><p class="font-medium">Total Botol Baru Keluar:</p><ul>${bottleList || '<li class="ml-4 text-sm text-slate-500">- Tidak ada -</li>'}</ul></div><div><p class="font-medium">Rincian Penjual:</p><ul>${sellerList}</ul></div><p class="mt-2 pt-2 border-t border-purple-200 dark:border-slate-600 font-semibold text-purple-700 dark:text-purple-400"><span class="font-medium text-slate-700 dark:text-slate-300">Total Pendapatan Bersih:</span> ${formatCurrency(item.totalRevenue - item.totalDiscount)}</p></div>`;
                container.appendChild(itemDiv);
            });
        };

        const renderExpenses = () => {
            const tableBody = document.getElementById('expenses-table-body');
            tableBody.innerHTML = '';
            if (expenses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 dark:text-slate-400 py-8">Belum ada pengeluaran hari ini.</td></tr>';
                return;
            }
            expenses.forEach(exp => {
                const row = document.createElement('tr');
                row.className = 'bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-purple-50 dark:hover:bg-slate-700';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${exp.type}</td><td class="px-6 py-4">${exp.description}</td><td class="px-6 py-4">${formatCurrency(exp.amount)}</td><td class="px-6 py-4"><button data-id="${exp.id}" class="delete-expense-btn text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></td>`;
                tableBody.appendChild(row);
            });
            tableBody.querySelectorAll('.delete-expense-btn').forEach(btn => btn.onclick = (e) => showCustomConfirm('Yakin ingin menghapus pengeluaran ini?', () => deleteExpense(e.currentTarget.dataset.id)));
        };

        const renderRecap = () => {
            const totalGross = sales.reduce((sum, sale) => sum + sale.price, 0);
            const totalDiscount = sales.reduce((sum, sale) => sum + sale.discount, 0);
            const totalNetSales = totalGross - totalDiscount;
            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const bonus = parseFloat(document.getElementById('recap-bonus').value.replace(/[^0-9]/g, '')) || 0;
            const netProfit = totalNetSales + bonus - totalExpenses;
            document.getElementById('recap-gross-sales').textContent = formatCurrency(totalGross);
            document.getElementById('recap-total-discount').textContent = `- ${formatCurrency(totalDiscount)}`;
            document.getElementById('recap-net-sales').textContent = formatCurrency(totalNetSales);
            document.getElementById('recap-total-expenses').textContent = `- ${formatCurrency(totalExpenses)}`;
            document.getElementById('recap-net-profit').textContent = formatCurrency(netProfit);
        };
        
        const updateLiveTotal = () => {
            const perfumeMili = parseFloat(onlyNumbers(document.getElementById('perfumeMili').value)) || 0;
            const pricePerMl = parseFloat(onlyNumbers(document.getElementById('pricePerMl').value)) || 0;
            const bottlePrice = parseFloat(onlyNumbers(document.getElementById('bottlePrice').value)) || 0;
            const bottlePcs = parseInt(onlyNumbers(document.getElementById('bottlePcs').value)) || 1;
            const discount = parseFloat(onlyNumbers(document.getElementById('discount').value)) || 0;
            const isRefill = isRefillCheckbox.checked;
            const bottlePriceComponent = isRefill ? 0 : bottlePrice;
            const totalJual = ((perfumeMili * pricePerMl) + bottlePriceComponent) * bottlePcs - discount;
            document.getElementById('total-jual-display').textContent = formatCurrency(totalJual);
        };

        const setupDataListenersForBranch = (branch) => {
            if (unsubscribeSales) unsubscribeSales();
            if (unsubscribeExpenses) unsubscribeExpenses();

            activeBranch = branch;
            sidebarTitle.textContent = activeBranch;
            document.getElementById('current-branch-display').textContent = `Cabang: ${activeBranch}`;
            inputShopName.value = activeBranch;

            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            
            const salesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/sales`), where("createdAt", ">=", startOfDay), where("createdAt", "<=", endOfDay));
            unsubscribeSales = onSnapshot(salesQuery, (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });

            const expensesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/expenses`), where("createdAt", ">=", startOfDay), where("createdAt", "<=", endOfDay));
            unsubscribeExpenses = onSnapshot(expensesQuery, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        };

        const setupGlobalListeners = (uid) => {
            if (unsubscribeSettings) unsubscribeSettings();
            if (unsubscribeBranches) unsubscribeBranches();
            
            const settingsDocRef = doc(db, `artifacts/${appId}/users/${uid}/settings/main`);
            unsubscribeSettings = onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) settings = docSnap.data();
                else saveSettings(settings);
                document.getElementById('setting-shop-name').value = settings.shopName;
                document.getElementById('setting-whatsapp-number').value = settings.whatsAppNumber;
                welcomeTitle.textContent = `Selamat Datang di ${settings.shopName}`;
            });

            const branchesCollectionRef = collection(db, `artifacts/${appId}/public/data/branches`);
            unsubscribeBranches = onSnapshot(branchesCollectionRef, (snapshot) => {
                branches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
                if (!initialBranchCheckDone && snapshot.empty) seedInitialBranches();
                initialBranchCheckDone = true;
                renderBranchManagementView();
                renderBranchSelectors();
            });
        };
        
        const addSale = async (saleData) => {
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/sales`), { ...saleData, createdAt: serverTimestamp() });
            } catch (e) { console.error("Error adding sale: ", e); showCustomAlert("Gagal menyimpan penjualan."); }
        };
        
        const deleteSale = async (id) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/sales`, id));
            } catch (e) { console.error("Error deleting sale: ", e); showCustomAlert("Gagal menghapus penjualan."); }
        };
        
        const addExpense = async (expenseData) => {
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/expenses`), { ...expenseData, createdAt: serverTimestamp() });
            } catch (e) { console.error("Error adding expense: ", e); showCustomAlert("Gagal menyimpan pengeluaran."); }
        };
        
        const deleteExpense = async (id) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/branch_stores/${activeBranch}/expenses`, id));
            } catch (e) { console.error("Error deleting expense: ", e); showCustomAlert("Gagal menghapus pengeluaran."); }
        };

        const saveSettings = async (settingsData) => {
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/settings/main`), settingsData, { merge: true });
                return true;
            } catch (e) { console.error("Error saving settings: ", e); showCustomAlert("Gagal menyimpan pengaturan."); return false; }
        };

        const addBranch = async (branchName) => {
            if (branches.some(b => b.name.toLowerCase() === branchName.toLowerCase())) {
                showCustomAlert(`Cabang "${branchName}" sudah ada.`);
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/branches`), { name: branchName });
                showCustomAlert('Cabang berhasil ditambahkan!');
            } catch (e) { console.error("Error adding branch: ", e); showCustomAlert("Gagal menambahkan cabang."); }
        };

        const deleteBranch = async (id) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/branches`, id));
                showCustomAlert('Cabang berhasil dihapus.');
            } catch (e) { console.error("Error deleting branch: ", e); showCustomAlert("Gagal menghapus cabang."); }
        };

        const seedInitialBranches = async () => {
            const initialBranchList = ["ANTASARI","CENDANA","KAHOI","M SAID","TEUKU UMAR","ANGGUR","GERILYA","KADRI ONENG","ULIN","DANAU PANGGANGA","MUNTAI 1","AMUNTAI 3","PALARAN","SANGA SANGA","SEBULU SATU","SEBULU DUA","TENGGARONG SATU","TENGGARONG DUA","SEPARI","TELUK DALAM L 2","TELUK DALAM L 3","LEMPAKE","PERAMUKA","KS TUBUN","GEROGOT SATU","GEROGOT DUA","SIM PAIT","BATU KAJANG SD","BATU KAJANG BPD","BATU KAJANG MANDIRI","SEPAKU","AMPAH","BUNTOK SATU","BUNTOK DUA","TAMIYANG SATU","MUARA TEWEH SATU","MUARA TEWEH DUA","PURUK CAHU SATU","KIM BARU SATU","SEBABI","PANGKALANBUN SATU","DISPORT","TEWAH","MUARAKOMAM","BUNG TOMO","KUALA KURUN","PARENGGEan SATU","PARENGGEan DUA","KA UBUN SATU","SANGKULIRANG","MUARA LAWA","BARONG TONGKOK SATU","BARONG TONGKOK DUA","SANGATA MARGO","SANGATA TELUK LINGGA","SANGATA HW","BATULICIN","SERONGGA"];
            const batch = writeBatch(db);
            const branchesCollectionRef = collection(db, `artifacts/${appId}/public/data/branches`);
            initialBranchList.forEach(name => batch.set(doc(branchesCollectionRef), { name }));
            try { await batch.commit(); } catch (e) { console.error("Error seeding branches: ", e); }
        };

        const fetchBranchDataForDate = async (branchName, date) => {
            const dateObj = new Date(date);
            const startOfDay = new Date(dateObj.setHours(0, 0, 0, 0));
            const endOfDay = new Date(dateObj.setHours(23, 59, 59, 999));

            const salesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${branchName}/sales`), where("createdAt", ">=", startOfDay), where("createdAt", "<=", endOfDay));
            const expensesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${branchName}/expenses`), where("createdAt", ">=", startOfDay), where("createdAt", "<=", endOfDay));

            const [salesSnapshot, expensesSnapshot] = await Promise.all([
                getDocs(salesQuery),
                getDocs(expensesQuery)
            ]);

            return {
                branchName,
                sales: salesSnapshot.docs.map(doc => doc.data()),
                expenses: expensesSnapshot.docs.map(doc => doc.data())
            };
        };
        
        const fetchAllDataForMonth = async (branchName, monthYear) => {
            const [year, month] = monthYear.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);

            const salesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${branchName}/sales`), where("createdAt", ">=", startDate), where("createdAt", "<=", endDate));
            const expensesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${branchName}/expenses`), where("createdAt", ">=", startDate), where("createdAt", "<=", endDate));

            const [salesSnapshot, expensesSnapshot] = await Promise.all([
                getDocs(salesQuery),
                getDocs(expensesQuery)
            ]);

            return {
                branchName,
                sales: salesSnapshot.docs.map(doc => ({...doc.data(), createdAt: doc.data().createdAt.toDate()})),
                expenses: expensesSnapshot.docs.map(doc => ({...doc.data(), createdAt: doc.data().createdAt.toDate()}))
            };
        };

        const generateSingleBranchPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const groupedSales = getGroupedSales();
            if (groupedSales.length === 0 && expenses.length === 0) {
                showCustomAlert("Tidak ada data untuk dibuatkan PDF.");
                return;
            }
            doc.setFontSize(18); doc.text("Laporan Penjualan Harian", 105, 20, { align: 'center' });
            doc.setFontSize(12); doc.text(settings.shopName, 105, 28, { align: 'center' });
            doc.setFontSize(10); doc.text(`Tanggal: ${getTodayDateString()} | Cabang: ${activeBranch}`, 105, 34, { align: 'center' });
            const tableBody = groupedSales.map(item => {
                const sellerDetails = Object.entries(item.sellers).map(([name, data]) => `- ${name}: ${data.totalMili} ml`).join('\n');
                const bottleDetails = Object.entries(item.bottles).map(([size, count]) => `- Botol ${size}: ${count} pcs`).join('\n');
                return [`${item.perfumeName}\nTotal: ${item.totalMili} ml`, bottleDetails || '- Tidak ada -', sellerDetails];
            });
            doc.autoTable({ head: [['Parfum & Total ML', 'Rincian Botol Baru', 'Rincian Penjual']], body: tableBody, startY: 40, theme: 'grid', headStyles: { fillColor: [88, 28, 135] }, styles: { valign: 'top' } });
            let finalY = doc.autoTable.previous.finalY, currentY = finalY + 15;
            const totalGross = sales.reduce((sum, s) => sum + s.price, 0);
            const totalDiscount = sales.reduce((sum, s) => sum + s.discount, 0);
            const totalNetSales = totalGross - totalDiscount;
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const bonus = parseFloat(document.getElementById('recap-bonus').value.replace(/[^0-9]/g, '')) || 0;
            const netProfit = totalNetSales + bonus - totalExpenses;
            doc.setFontSize(14); doc.text("Rekap Keuangan", 14, currentY);
            doc.setFontSize(10);
            const recapItems = [["Total Omset Bruto", formatCurrency(totalGross)], ["Total Diskon Diberikan", formatCurrency(totalDiscount)], ["Total Penjualan Bersih", formatCurrency(totalNetSales)], ["Bonus Omset Diterima", formatCurrency(bonus)], ["Total Pengeluaran", formatCurrency(totalExpenses)]];
            recapItems.forEach(item => { currentY += 7; doc.text(item[0], 14, currentY); doc.text(item[1], 200, currentY, { align: 'right' }); });
            currentY += 2; doc.line(14, currentY, 200, currentY); currentY += 7;
            doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("TOTAL BERSIH HARIAN", 14, currentY); doc.text(formatCurrency(netProfit), 200, currentY, { align: 'right' });
            doc.setFont(undefined, 'normal'); doc.setFontSize(9); doc.setTextColor(150); doc.text(`Laporan dibuat pada ${new Date().toLocaleString('id-ID')}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
            doc.save(`Laporan_${activeBranch.replace(/ /g, '_')}_${getTodayDateString()}.pdf`);
        }

        const generateGlobalPdf = async () => {
            const date = globalReportDateInput.value;
            const branchName = document.getElementById('global-report-branch').value;

            if (!branchName || !branches.some(b => b.name === branchName)) {
                showCustomAlert("Silakan pilih cabang yang valid dari daftar.");
                return;
            }
            if (!date) {
                showCustomAlert("Silakan pilih tanggal laporan terlebih dahulu.");
                return;
            }
            
            globalReportLoader.classList.remove('hidden');
            downloadGlobalReportBtn.disabled = true;

            try {
                const data = await fetchBranchDataForDate(branchName, date);

                if (data.sales.length === 0 && data.expenses.length === 0) {
                    showCustomAlert(`Tidak ada data untuk cabang ${branchName} pada tanggal ${date}.`);
                    globalReportLoader.classList.add('hidden');
                    downloadGlobalReportBtn.disabled = false;
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.text(`Laporan Harian - Cabang ${data.branchName}`, 14, 22);
                doc.setFontSize(10); doc.setFont(undefined, 'normal'); doc.text(`Tanggal: ${date}`, 14, 28);

                let lastY = 35;

                if (data.sales.length > 0) {
                    doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("Rincian Penjualan", 14, lastY); lastY += 5;
                    const salesBody = data.sales.map(s => [s.perfumeName, s.sellerName, `${s.perfumeMili}ml (${s.bottlePcs} pcs)`, formatCurrency(s.price - s.discount)]);
                    doc.autoTable({ head: [['Parfum', 'Penjual', 'Detail', 'Total']], body: salesBody, startY: lastY, theme: 'grid', headStyles: { fillColor: [88, 28, 135] } });
                    lastY = doc.autoTable.previous.finalY + 10;
                }

                if (data.expenses.length > 0) {
                    doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("Rincian Pengeluaran", 14, lastY); lastY += 5;
                    const expensesBody = data.expenses.map(e => [e.type, e.description, formatCurrency(e.amount)]);
                    doc.autoTable({ head: [['Jenis', 'Keterangan', 'Jumlah']], body: expensesBody, startY: lastY, theme: 'grid', headStyles: { fillColor: [200, 80, 80] } });
                    lastY = doc.autoTable.previous.finalY + 10;
                }
                
                const totalGross = data.sales.reduce((sum, s) => sum + s.price, 0);
                const totalDiscount = data.sales.reduce((sum, s) => sum + s.discount, 0);
                const totalNetSales = totalGross - totalDiscount;
                const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
                const netProfit = totalNetSales - totalExpenses;

                doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("Rekap Keuangan Cabang", 14, lastY); lastY += 7;
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                doc.text(`Total Omset Bruto: ${formatCurrency(totalGross)}`, 14, lastY); lastY += 6;
                doc.text(`Total Diskon: ${formatCurrency(totalDiscount)}`, 14, lastY); lastY += 6;
                doc.setFont(undefined, 'bold'); doc.text(`Total Penjualan Bersih: ${formatCurrency(totalNetSales)}`, 14, lastY); lastY += 6;
                doc.setFont(undefined, 'normal'); doc.text(`Total Pengeluaran: ${formatCurrency(totalExpenses)}`, 14, lastY); lastY += 8;
                doc.setFont(undefined, 'bold'); doc.setFontSize(12); doc.text(`TOTAL BERSIH CABANG: ${formatCurrency(netProfit)}`, 14, lastY);
                
                doc.save(`Laporan_${branchName.replace(/ /g, '_')}_${date}.pdf`);

            } catch (error) {
                console.error("Error generating global report:", error);
                showCustomAlert("Gagal membuat laporan. Silakan coba lagi.");
            } finally {
                globalReportLoader.classList.add('hidden');
                downloadGlobalReportBtn.disabled = false;
            }
        };

        const fetchAllSalesForMonth = async (monthYear) => {
            const [year, month] = monthYear.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);
            
            const allSales = [];
            for (const branch of branches) {
                const salesQuery = query(collection(db, `artifacts/${appId}/public/data/branch_stores/${branch.name}/sales`), where("createdAt", ">=", startDate), where("createdAt", "<=", endDate));
                const salesSnapshot = await getDocs(salesQuery);
                salesSnapshot.forEach(doc => {
                    allSales.push({ branchName: branch.name, ...doc.data() });
                });
            }
            return allSales;
        };

        const generateMasterExcel = async () => {
            const monthYear = masterReportMonthInput.value;
            if (!monthYear) { showCustomAlert("Silakan pilih bulan laporan."); return; }

            masterReportLoader.classList.remove('hidden');
            document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = true);

            try {
                const allSales = await fetchAllSalesForMonth(monthYear);
                if (allSales.length === 0) {
                    showCustomAlert("Tidak ada data penjualan pada bulan yang dipilih.");
                    return;
                }
                
                const allBranchDataPromises = branches.map(branch => fetchAllDataForMonth(branch.name, monthYear));
                const allBranchData = await Promise.all(allBranchDataPromises);
                
                // Sheet 1: Rincian Penjualan
                const salesDetailsData = allSales.sort((a,b) => a.sellerName.localeCompare(b.sellerName) || a.branchName.localeCompare(b.branchName))
                    .map(sale => ({
                        Tanggal: sale.createdAt.toISOString().slice(0,10),
                        'Nama Penjual': sale.sellerName,
                        'Cabang': sale.branchName,
                        'Nama Parfum': sale.perfumeName,
                        'Mili': sale.perfumeMili,
                        'Pcs': sale.bottlePcs,
                        'Ukuran Botol': sale.bottleSize,
                        'Isi Ulang': sale.isRefill ? "Ya" : "Tidak",
                        'Harga Jual': sale.price,
                        'Diskon': sale.discount,
                        'Total Bersih': sale.price - sale.discount
                    }));

                // Sheet 2: Rekap Item Global
                const itemRecap = allSales.reduce((acc, sale) => {
                    const key = sale.perfumeName;
                    if(!acc[key]) acc[key] = { 'Nama Parfum': key, 'Total ML Terjual': 0, 'Total Pcs Terjual': 0 };
                    acc[key]['Total ML Terjual'] += sale.perfumeMili * sale.bottlePcs;
                    acc[key]['Total Pcs Terjual'] += sale.bottlePcs;
                    return acc;
                }, {});
                const itemRecapData = Object.values(itemRecap).sort((a,b) => b['Total ML Terjual'] - a['Total ML Terjual']);

                // Sheet 3: Rekap Botol Global
                const bottleRecap = allSales.filter(s => !s.isRefill).reduce((acc, sale) => {
                    const key = sale.bottleSize;
                    if(!acc[key]) acc[key] = { 'Ukuran Botol': key, 'Total Pcs Terjual': 0 };
                    acc[key]['Total Pcs Terjual'] += sale.bottlePcs;
                    return acc;
                }, {});
                const bottleRecapData = Object.values(bottleRecap).sort((a,b) => b['Total Pcs Terjual'] - a['Total Pcs Terjual']);

                // Sheet 4: Rekap Keuangan Global
                const financialRecapData = allBranchData.map(data => {
                    const totalGross = data.sales.reduce((sum, s) => sum + s.price, 0);
                    const totalDiscount = data.sales.reduce((sum, s) => sum + s.discount, 0);
                    const totalNetSales = totalGross - totalDiscount;
                    const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
                    const netProfit = totalNetSales - totalExpenses;
                    return {
                        'Cabang': data.branchName,
                        'Omset Bruto': totalGross,
                        'Total Diskon': totalDiscount,
                        'Penjualan Bersih': totalNetSales,
                        'Total Pengeluaran': totalExpenses,
                        'Laba Bersih': netProfit
                    };
                });

                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.json_to_sheet(salesDetailsData);
                const ws2 = XLSX.utils.json_to_sheet(itemRecapData);
                const ws3 = XLSX.utils.json_to_sheet(bottleRecapData);
                const ws4 = XLSX.utils.json_to_sheet(financialRecapData);
                
                XLSX.utils.book_append_sheet(wb, ws1, "Rincian Penjualan");
                XLSX.utils.book_append_sheet(wb, ws2, "Rekap Item Global");
                XLSX.utils.book_append_sheet(wb, ws3, "Rekap Botol Global");
                XLSX.utils.book_append_sheet(wb, ws4, "Rekap Keuangan Global");

                XLSX.writeFile(wb, `Laporan_Master_Lengkap_${monthYear}.xlsx`);

            } catch (error) {
                console.error("Error generating master Excel:", error);
                showCustomAlert("Gagal membuat laporan master Excel.");
            } finally {
                masterReportLoader.classList.add('hidden');
                document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = false);
            }
        };
        
        const generateMonthlyFinancePdf = async () => {
            const monthYear = masterReportMonthInput.value;
            if (!monthYear) { showCustomAlert("Silakan pilih bulan dan tahun laporan."); return; }
            
            masterReportLoader.classList.remove('hidden');
            document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = true);

            try {
                const allBranchDataPromises = branches.map(branch => fetchAllDataForMonth(branch.name, monthYear));
                const allBranchData = await Promise.all(allBranchDataPromises);
                
                if (allBranchData.every(d => d.sales.length === 0 && d.expenses.length === 0)) {
                    showCustomAlert(`Tidak ada data untuk bulan ${monthYear}.`);
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Page 1: Global Summary
                doc.setFontSize(18); doc.text(`Laporan Keuangan Global - ${monthYear}`, 105, 20, { align: 'center' });
                
                let globalTotalSales = 0;
                let globalTotalExpenses = 0;
                const branchSummaries = [];

                allBranchData.forEach(data => {
                    const totalSales = data.sales.reduce((sum, s) => sum + (s.price - s.discount), 0);
                    const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
                    globalTotalSales += totalSales;
                    globalTotalExpenses += totalExpenses;
                    if (totalSales > 0 || totalExpenses > 0) {
                        branchSummaries.push([data.branchName, formatCurrency(totalSales), formatCurrency(totalExpenses), formatCurrency(totalSales - totalExpenses)]);
                    }
                });
                
                let lastY = 35;
                doc.setFontSize(12).setFont(undefined, 'bold');
                doc.text("Ringkasan Global (Semua Cabang)", 14, lastY);
                doc.setFontSize(10).setFont(undefined, 'normal');
                lastY += 7;
                doc.text(`Total Pemasukan Bersih: ${formatCurrency(globalTotalSales)}`, 14, lastY);
                lastY += 7;
                doc.text(`Total Pengeluaran: ${formatCurrency(globalTotalExpenses)}`, 14, lastY);
                lastY += 7;
                doc.setFont(undefined, 'bold');
                doc.text(`OMSET BERSIH GLOBAL: ${formatCurrency(globalTotalSales - globalTotalExpenses)}`, 14, lastY);
                lastY += 12;

                doc.autoTable({
                    head: [['Cabang', 'Total Pemasukan', 'Total Pengeluaran', 'Omset Bersih']],
                    body: branchSummaries,
                    startY: lastY,
                    theme: 'grid',
                    headStyles: { fillColor: [88, 28, 135] }
                });
                lastY = doc.autoTable.previous.finalY;

                // Subsequent pages: Detailed branch reports
                allBranchData.forEach(data => {
                    const dailyData = {};
                    [...data.sales, ...data.expenses].forEach(t => {
                        const date = t.createdAt.toISOString().slice(0, 10);
                        if (!dailyData[date]) dailyData[date] = { sales: 0, expenses: 0 };
                        dailyData[date][t.price ? 'sales' : 'expenses'] += t.price ? (t.price - t.discount) : t.amount;
                    });
                    
                    const sortedDaily = Object.entries(dailyData).sort((a,b) => a[0].localeCompare(b[0]));
                    if (sortedDaily.length === 0) return;

                    doc.addPage();
                    doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.text(`Rincian Keuangan Bulanan - Cabang ${data.branchName}`, 14, 22);
                    doc.setFontSize(10); doc.setFont(undefined, 'normal'); doc.text(monthYear, 14, 28);

                    const dailyBody = sortedDaily.map(([day, data]) => [day, formatCurrency(data.sales), formatCurrency(data.expenses), formatCurrency(data.sales - data.expenses)]);
                    
                    doc.autoTable({
                        head: [['Tanggal', 'Pemasukan', 'Pengeluaran', 'Laba/Rugi Harian']],
                        body: dailyBody,
                        startY: 35,
                        theme: 'striped'
                    });
                });

                doc.save(`Laporan_Keuangan_Bulanan_${monthYear}.pdf`);

            } catch (error) {
                console.error("Error generating monthly finance PDF:", error);
                showCustomAlert("Gagal membuat laporan keuangan bulanan.");
            } finally {
                masterReportLoader.classList.add('hidden');
                document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = false);
            }
        };
        
        const generatePrintableMasterReport = async () => {
            const monthYear = masterReportMonthInput.value;
            if (!monthYear) { showCustomAlert("Silakan pilih bulan dan tahun laporan."); return; }
            
            masterReportLoader.classList.remove('hidden');
            document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = true);

            try {
                const allBranchDataPromises = branches.map(branch => fetchAllDataForMonth(branch.name, monthYear));
                const allBranchData = await Promise.all(allBranchDataPromises);
                
                if (allBranchData.every(d => d.sales.length === 0 && d.expenses.length === 0)) {
                    showCustomAlert(`Tidak ada data untuk bulan ${monthYear}.`);
                    return;
                }

                let printHTML = `<div class="p-8 font-sans">`;
                printHTML += `<h1 class="text-3xl font-bold text-center mb-2">Laporan Master Global</h1>`;
                printHTML += `<h2 class="text-xl text-center mb-8">${settings.shopName} - ${monthYear}</h2>`;

                // Global Summary
                let globalTotalSales = 0;
                let globalTotalExpenses = 0;
                const branchSummaries = [];

                allBranchData.forEach(data => {
                    const totalSales = data.sales.reduce((sum, s) => sum + (s.price - s.discount), 0);
                    const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
                    globalTotalSales += totalSales;
                    globalTotalExpenses += totalExpenses;
                    if (totalSales > 0 || totalExpenses > 0) {
                        branchSummaries.push({
                            name: data.branchName,
                            sales: totalSales,
                            expenses: totalExpenses,
                            profit: totalSales - totalExpenses
                        });
                    }
                });

                printHTML += `<div class="mb-8 p-4 border rounded-lg">`;
                printHTML += `<h3 class="text-lg font-bold mb-2">Ringkasan Global (Semua Cabang)</h3>`;
                printHTML += `<p><strong>Total Pemasukan Bersih:</strong> ${formatCurrency(globalTotalSales)}</p>`;
                printHTML += `<p><strong>Total Pengeluaran:</strong> ${formatCurrency(globalTotalExpenses)}</p>`;
                printHTML += `<p class="text-lg font-bold mt-2">OMSET BERSIH GLOBAL: ${formatCurrency(globalTotalSales - globalTotalExpenses)}</p>`;
                printHTML += `</div>`;
                
                // Per-Branch Summary Table
                printHTML += `<h3 class="text-lg font-bold mb-2">Rekap Keuangan per Cabang</h3>`;
                printHTML += `<table class="w-full text-sm border-collapse border border-slate-400"><thead><tr class="bg-slate-200">
                    <th class="border border-slate-300 p-2 text-left">Cabang</th>
                    <th class="border border-slate-300 p-2 text-right">Pemasukan</th>
                    <th class="border border-slate-300 p-2 text-right">Pengeluaran</th>
                    <th class="border border-slate-300 p-2 text-right">Omset Bersih</th>
                </tr></thead><tbody>`;
                branchSummaries.forEach(s => {
                    printHTML += `<tr>
                        <td class="border border-slate-300 p-2">${s.name}</td>
                        <td class="border border-slate-300 p-2 text-right">${formatCurrency(s.sales)}</td>
                        <td class="border border-slate-300 p-2 text-right">${formatCurrency(s.expenses)}</td>
                        <td class="border border-slate-300 p-2 text-right font-bold">${formatCurrency(s.profit)}</td>
                    </tr>`;
                });
                printHTML += `</tbody></table>`;
                
                // Item Recap
                const allSales = allBranchData.flatMap(d => d.sales);
                const itemRecap = allSales.reduce((acc, sale) => {
                    const key = sale.perfumeName;
                    if(!acc[key]) acc[key] = { 'Nama Parfum': key, 'Total ML Terjual': 0, 'Total Pcs Terjual': 0 };
                    acc[key]['Total ML Terjual'] += sale.perfumeMili * sale.bottlePcs;
                    acc[key]['Total Pcs Terjual'] += sale.bottlePcs;
                    return acc;
                }, {});
                const itemRecapData = Object.values(itemRecap).sort((a,b) => b['Total ML Terjual'] - a['Total ML Terjual']);

                printHTML += `<div class="mt-8" style="page-break-before: always;">`;
                printHTML += `<h3 class="text-lg font-bold mb-2">Rekap Barang Terlaris (Global)</h3>`;
                printHTML += `<table class="w-full text-sm border-collapse border border-slate-400"><thead><tr class="bg-slate-200">
                    <th class="border border-slate-300 p-2 text-left">Nama Parfum</th>
                    <th class="border border-slate-300 p-2 text-right">Total ML</th>
                    <th class="border border-slate-300 p-2 text-right">Total Pcs</th>
                </tr></thead><tbody>`;
                itemRecapData.forEach(item => {
                    printHTML += `<tr>
                        <td class="border border-slate-300 p-2">${item['Nama Parfum']}</td>
                        <td class="border border-slate-300 p-2 text-right">${item['Total ML Terjual']}</td>
                        <td class="border border-slate-300 p-2 text-right">${item['Total Pcs Terjual']}</td>
                    </tr>`;
                });
                printHTML += `</tbody></table></div>`;

                // Detailed reports per branch
                allBranchData.forEach(data => {
                     if (data.sales.length === 0 && data.expenses.length === 0) return;
                     printHTML += `<div class="mt-8" style="page-break-before: always;">`;
                     printHTML += `<h2 class="text-2xl font-bold mb-4 text-center">Rincian Cabang: ${data.branchName}</h2>`;
                     
                     if (data.sales.length > 0) {
                         printHTML += `<h3 class="text-lg font-bold mb-2">Penjualan</h3>`;
                         printHTML += `<table class="w-full text-sm border-collapse border border-slate-400"><thead><tr class="bg-slate-200">
                            <th class="border border-slate-300 p-2 text-left">Tanggal</th>
                            <th class="border border-slate-300 p-2 text-left">Penjual</th>
                            <th class="border border-slate-300 p-2 text-left">Parfum</th>
                            <th class="border border-slate-300 p-2 text-right">Total</th>
                         </tr></thead><tbody>`;
                         data.sales.forEach(s => {
                             printHTML += `<tr>
                                <td class="border border-slate-300 p-2">${s.createdAt.toISOString().slice(0,10)}</td>
                                <td class="border border-slate-300 p-2">${s.sellerName}</td>
                                <td class="border border-slate-300 p-2">${s.perfumeName} (${s.perfumeMili}ml)</td>
                                <td class="border border-slate-300 p-2 text-right">${formatCurrency(s.price - s.discount)}</td>
                             </tr>`;
                         });
                         printHTML += `</tbody></table>`;
                     }

                     if (data.expenses.length > 0) {
                         printHTML += `<h3 class="text-lg font-bold mt-6 mb-2">Pengeluaran</h3>`;
                         printHTML += `<table class="w-full text-sm border-collapse border border-slate-400"><thead><tr class="bg-slate-200">
                            <th class="border border-slate-300 p-2 text-left">Tanggal</th>
                            <th class="border border-slate-300 p-2 text-left">Jenis</th>
                            <th class="border border-slate-300 p-2 text-left">Keterangan</th>
                            <th class="border border-slate-300 p-2 text-right">Jumlah</th>
                         </tr></thead><tbody>`;
                         data.expenses.forEach(e => {
                             printHTML += `<tr>
                                <td class="border border-slate-300 p-2">${e.createdAt.toISOString().slice(0,10)}</td>
                                <td class="border border-slate-300 p-2">${e.type}</td>
                                <td class="border border-slate-300 p-2">${e.description}</td>
                                <td class="border border-slate-300 p-2 text-right">${formatCurrency(e.amount)}</td>
                             </tr>`;
                         });
                         printHTML += `</tbody></table>`;
                     }
                     printHTML += `</div>`;
                });
                
                printHTML += `</div>`; // Close wrapper

                document.getElementById('print-area').innerHTML = printHTML;
                window.print();

            } catch (error) {
                console.error("Error generating printable report:", error);
                showCustomAlert("Gagal membuat laporan cetak.");
            } finally {
                masterReportLoader.classList.add('hidden');
                document.querySelectorAll('#master-report-controls button').forEach(btn => btn.disabled = false);
            }
        };


        const perfumeList = ["1000 BUNGA","2000 BUNGA","212 MAN","212 MAN KW1","212 SEXY MAN","AIGNER BLUE","ALPHA","ANGEL HEART","ANNA SUI DREAM","ANNA SUI FLIGHT OF FANCY","ANTONIO BANDERAS","AQUA DI GIO MAN","AQUA KISS","ASHANTY","AVRIL FORBIDDEN ROSE","AXE SIGNATURE","AZZARO THE MOST WANTED","BACCARAT","BACCARAT ROSE","BACCARAT SUPER","BAKHOR","BCL","BLACK OPIUM","BLACK OPIUM FLORAL","BLACK XS","BODY SHOP VANILLA","BODY SHOP WOMEN","BRITNEY FANTASY","BRITNEY FANTASY MIDNIGHT","BUBBLE GUM","BUBBLE PINK","BULGARI BLACK","BURBERYS","BURBERYS LONDON","BVLGARI AQUA MARINE","BVLGARI AQUA POUR HOMME","BVLGARI EXTREME","BVLGARI OMNIA AMETHYST","BVLGARI OMNIA CORAL","BVLGARI OMNIA CRYSTALLINE","BVLGARI WOMEN","CADA SEXY GRAVITY","CHARLIE WHITE","CHRISTIAN DIOR OLYMPEA","CHRISTIAN DIOR SAUVAGE","CRISTIANO RONALDO","D&G ANTHOLOGY","D&G LIGHT BLUE WOMEN","D&G ROSE THE ONE","DALAL","DAVIDOFF COOL WATER WOMEN","DIAMOR WOMEN","DRAKKAR NOIR","DUNHILL DESIRE BLUE","DUNHILL POUR MAN","ESCADA MAGNETISM","ESCADA MOON SPARKLE","ETERNITY FOR WOMEN","ETERNITY MAN","FERRARI","GUEST PINK","GUESS WOMEN","HAJAR ASWAD","HARAJUKU GWEN","HARAJUKU LOVE","HUGO BOSS ENERGISE","HUGO BOSS ORANGE","HUGO BOSS RED","HUGO BOSS XX","HUGO BOSS XY","INCANTO SHINE","ISSEY MIYAKE","ISSEY MIYAKE SPORT","JAMES BOND 007","JLO PLATINUM","JLO STILL","JUSTIN BIEBER SOMEDAY","KASTURI KIJANG","KASTURI PUTIH","KENZO BALI","KENZO BAMBU","KENZO DAUN","KING AZIZ","LOUIS VUITTON","LOVE SARAH","LUX","MALAIKAT SUBUH","MANCHESTER","MANOHARA","MELATI KERATON","MISIK HITAM MILIAN","MISIK MILIAN","MONTBLANC LEGEND","NAGITA SLAVINA","NYC SCENTS","OLLA RAMLAN","OLYMPEA","PARIS HILTON CAN CAN","PARIS HILTON HEIRESS","PARIS HILTON PASSPORT PARIS","PARIS HILTON SIREN","PARIS HILTON WOMEN","PAUL SMITH","PINK CHIFFON","PLAYBOY VIP HIM","POLO SPORT","QABA","QUICKSILVER","RAFFI AHMAD","SCANDALOUS","SECRET WISH","SELENA GOMEZ","SILVER","STARSHIP","TAYLOR SWIFT FOR WOMEN","TIK-TOK WOMEN","VALENTINO","VANILLA CAKE","VANILLA CARAMEL","VANILLA LACE","VANILLA SUSU","VIA VALLEN","VICTORIA SECRET BOMBSHELL","VICTORIA SECRET CHOCO PASSION","VICTORIA SECRET ROMANTIC WISH","VICTORIA SECRET WISH RAVISHING LOVE","WAYNE ROONEY","WHITE BEAUTY","YSL BLACK SUPER","ZAFARON MILIAN"];
        const bottleSizeList = ["BOTOL 10 ML","BOTOL 12 ML SPRAY","BOTOL 20 ML SPRAY","BOTOL 30 ML SPRAY","BOTOL 50 ML SPRAY","BOTOL 100 ML SPRAY"];

        const populateLists = () => {
            const perfumeDatalist = document.getElementById('perfume-list');
            perfumeDatalist.innerHTML = '';
            perfumeList.sort().forEach(p => { const o = document.createElement('option'); o.value = p; perfumeDatalist.appendChild(o); });
            const bottleDatalist = document.getElementById('bottle-size-list');
            bottleDatalist.innerHTML = '';
            bottleSizeList.sort().forEach(s => { const o = document.createElement('option'); o.value = s; bottleDatalist.appendChild(o); });
        };

        const initializeEventListeners = () => {
            navItems.forEach(item => item.onclick = (e) => {
                const viewId = e.currentTarget.dataset.view;
                views.forEach(v => v.style.display = 'none');
                document.getElementById(`view-${viewId}`).style.display = 'block';
                navItems.forEach(nav => nav.classList.remove('bg-purple-600', 'text-white', 'shadow-md'));
                e.currentTarget.classList.add('bg-purple-600', 'text-white', 'shadow-md');
                const today = getTodayDateString();
                if(viewId === 'global-report') globalReportDateInput.value = today;
                if(viewId === 'master-report') masterReportMonthInput.value = today.substring(0, 7);
                renderAll();
            });

            salesForm.onsubmit = (e) => {
                e.preventDefault();
                const sellerName = document.getElementById('input-seller-name').value.trim();
                const perfumeName = document.getElementById('perfumeName').value.trim();
                const perfumeMili = document.getElementById('perfumeMili').value.trim();
                const pricePerMl = document.getElementById('pricePerMl').value.trim();
                const bottlePrice = document.getElementById('bottlePrice').value.trim();
                const bottleSize = document.getElementById('bottleSize').value.trim();
                const bottlePcs = document.getElementById('bottlePcs').value.trim();
                const discount = document.getElementById('discount').value.trim();
                const isRefill = isRefillCheckbox.checked;
                if (!sellerName || !perfumeName || !perfumeMili || !pricePerMl || (!isRefill && (!bottlePrice || !bottleSize))) {
                    showCustomAlert("Harap isi semua kolom yang diperlukan."); return;
                }
                const bottlePriceComponent = isRefill ? 0 : parseFloat(bottlePrice);
                const finalBottleSize = isRefill ? 'Isi Ulang' : bottleSize;
                const totalGrossPrice = ((parseFloat(perfumeMili) * parseFloat(pricePerMl)) + bottlePriceComponent) * (parseInt(bottlePcs) || 1);
                addSale({ sellerName, perfumeName, perfumeMili: parseFloat(perfumeMili), pricePerMl: parseFloat(pricePerMl), bottlePrice: parseFloat(bottlePrice) || 0, bottleSize: finalBottleSize, bottlePcs: parseInt(bottlePcs) || 1, discount: parseFloat(discount) || 0, isRefill, price: totalGrossPrice });
                salesForm.reset();
                document.getElementById('bottlePcs').value = '1';
                document.getElementById('discount').value = '0';
                isRefillCheckbox.checked = false;
                updateLiveTotal();
                showCustomAlert('Data penjualan berhasil ditambahkan!');
            };
            
            ['perfumeMili', 'pricePerMl', 'bottlePrice', 'bottlePcs', 'discount'].forEach(id => document.getElementById(id).oninput = () => updateLiveTotal());
            isRefillCheckbox.onchange = () => {
                const disabled = isRefillCheckbox.checked;
                document.getElementById('bottlePrice').disabled = disabled;
                document.getElementById('bottleSize').disabled = disabled;
                if(disabled) { document.getElementById('bottlePrice').value = ''; document.getElementById('bottleSize').value = ''; }
                updateLiveTotal();
            };

            expensesForm.onsubmit = (e) => {
                e.preventDefault();
                const type = document.getElementById('expense-type').value;
                const description = document.getElementById('expense-description').value.trim();
                const amount = document.getElementById('expense-amount').value.trim();
                if (!description || !amount) { showCustomAlert("Keterangan dan Jumlah tidak boleh kosong."); return; }
                addExpense({ type, description, amount: parseFloat(amount) });
                expensesForm.reset();
                showCustomAlert('Data pengeluaran berhasil ditambahkan!');
            };
            
            branchForm.onsubmit = e => {
                e.preventDefault();
                const input = document.getElementById('branch-name-input');
                if (input.value.trim()) { addBranch(input.value.trim()); input.value = ''; }
            };

            openSettingsBtn.onclick = () => showCustomModal(document.getElementById('settings-modal').querySelector('.bg-white'));
            closeSettingsBtn.onclick = () => hideCustomModal(document.getElementById('settings-modal').querySelector('.bg-white'));
            settingsForm.onsubmit = async (e) => {
                e.preventDefault();
                const success = await saveSettings({ shopName: document.getElementById('setting-shop-name').value, whatsAppNumber: document.getElementById('setting-whatsapp-number').value });
                if (success) { showCustomAlert('Pengaturan berhasil disimpan!'); hideCustomModal(document.getElementById('settings-modal').querySelector('.bg-white')); }
            };

            document.getElementById('recap-bonus').oninput = renderRecap;
            createPdfBtn.onclick = () => generateSingleBranchPdf();
            downloadGlobalReportBtn.onclick = generateGlobalPdf;
            downloadMasterExcelBtn.onclick = generateMasterExcel;
            downloadMonthlyFinanceBtn.onclick = generateMonthlyFinancePdf;
            printMasterReportBtn.onclick = generatePrintableMasterReport;

            passcodeSubmitBtn.onclick = () => {
                const input = document.getElementById('passcode-input');
                if (input.value === '86849000') {
                    passcodeSection.classList.add('hidden');
                    masterReportControls.classList.remove('hidden');
                } else {
                    showCustomAlert('Kode sandi salah.');
                    input.value = '';
                }
            };

            sendWaReportBtn.onclick = () => {
                if (!settings.whatsAppNumber) { showCustomAlert("Mohon isi nomor WhatsApp Pusat di Pengaturan."); return; }
                const sanitizedWaNumber = settings.whatsAppNumber.replace(/\D/g, '');
                const groupedArray = getGroupedSales();
                const itemsSummary = groupedArray.length > 0 ? groupedArray.map(item => `*${item.perfumeName}* (Total: ${item.totalMili} ml)\n${Object.entries(item.sellers).map(([name, data]) => `   - ${name}: ${data.totalMili} ml`).join('\n')}`).join('\n\n') : "Tidak ada penjualan item.";
                const totalGross = sales.reduce((sum, s) => sum + s.price, 0);
                const totalDiscount = sales.reduce((sum, s) => sum + s.discount, 0);
                const totalNetSales = totalGross - totalDiscount;
                const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                const bonus = parseFloat(document.getElementById('recap-bonus').value) || 0;
                const totalBersihHarian = totalNetSales + bonus - totalExpenses;
                const financeRecap = `*Rekap Keuangan Harian:*\nTotal Omset Bruto: ${formatCurrency(totalGross)}\nTotal Diskon Diberikan: ${formatCurrency(totalDiscount)}\n*Total Penjualan Bersih: ${formatCurrency(totalNetSales)}*\nBonus Omset Diterima: ${formatCurrency(bonus)}\nTotal Pengeluaran: ${formatCurrency(totalExpenses)}\n*TOTAL BERSIH HARIAN: ${formatCurrency(totalBersihHarian)}*`;
                const fullMessage = `*Laporan Penjualan Harian - ${settings.shopName}*\n*Cabang: ${activeBranch}*\nTanggal: ${getTodayDateString()}\n\n*Ringkasan Penjualan Item:*\n${itemsSummary}\n\n\n${financeRecap}`;
                window.open(`https://wa.me/${sanitizedWaNumber}?text=${encodeURIComponent(fullMessage)}`, '_blank');
            };

            themeToggle.onclick = () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark');
            
            selectBranchBtn.onclick = () => {
                const selectedBranch = branchSelectionInput.value;
                if (selectedBranch && branches.some(b => b.name === selectedBranch)) {
                    sessionStorage.setItem('activeBranch', selectedBranch);
                    branchSelectorContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    document.body.classList.remove('modal-open');
                    setupDataListenersForBranch(selectedBranch);
                } else {
                    showCustomAlert('Silakan pilih cabang yang valid dari daftar.');
                }
            };
            
            changeBranchBtn.onclick = () => {
                sessionStorage.removeItem('activeBranch');
                window.location.reload();
            };

            manageBranchesBtn.onclick = () => showCustomModal(branchModalContent);
            closeBranchModalBtn.onclick = () => hideCustomModal(branchModalContent);
            supportIcon.onclick = () => supportPopup.classList.toggle('hidden');
            document.addEventListener('click', (e) => {
                if (!supportIcon.contains(e.target) && !supportPopup.contains(e.target)) {
                    supportPopup.classList.add('hidden');
                }
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                setupGlobalListeners(userId);
                const savedBranch = sessionStorage.getItem('activeBranch');
                if (savedBranch) {
                    branchSelectorContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setupDataListenersForBranch(savedBranch);
                } else {
                    branchSelectorContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            }
        });

        window.addEventListener('load', async () => {
            populateLists();
            initializeEventListeners();
            applyTheme(localStorage.getItem('theme') || 'light');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showCustomAlert("Gagal melakukan autentikasi.");
            }
        });
    </script>


</body></html>